## Pattern Avoidance
有$n$个高低各不相同的孩子，占成一列，每个人面向前一个人的背部。要求每个人必须能够看到所有比自己矮的人在自己的前面。有多少种不同的列队方式呢？  
令$1,2,3,\cdots,n$表示依序各个孩子，$1$最矮$n$最高。  
例子$1423567$符合要求吗？不。因为2和3看不到1，被4挡住了。例子$6723415$是符合要求的。  
什么时候是符合要求的呢？如果没有三个元素$a,b,c$是一列中的三个（无需连续）且$a<c<b$，就是符合要求的。如果存在的话，那么$c$看不到$a$。

**Definition 14.1.** 令$a,b,c$是某个排列从左到右按序的三项（不要求连续）。如果$a<c<b$，那么称为132模式(`132-pattern`)。  
为什么称为132模式呢？因为它们三项相对的高度和1、3、2一致。最左边的最小，中间最高，最右的居中。类似的，如果$a<b<c$，那么称为123模式，如果$c<a<b$，那么是231模式。

**Definition 14.2.** 令$p$是一个排列。如果$p$中没有三项能够形成132模式，那么$p$被称为`132-avoiding`。  
我们的目标是求得长度为$n$的是`132-avoiding`的排列数$f(n)$.  
假设某个`132-avoiding`排列的$n$位于位置$i$，那么$n$左边的元素都比$n$右边的元素大。反证。如果左右有$x$小于右边的某个元素$y$，那么$xny$是132模式。所以$1,2,3,\cdots,n-i$在右边，$n-i+1,n-i+2,\cdots,n-1$在左边。左边$n-1$个元素形成`132-avoiding`排列数是$f(i-1)$，类似的，右边$n-i$个元素形成`132-avoiding`排列数是$f(n-i)$。对于$n$在位置$i$的情况，共有$f(i-1)f(n-i)$种排列。为了递归正确，令$f(0)=1$。  
对$i\in [n]$求和
$$f(n)=\sum_{i=1}^n f(i-1)f(n-i)\tag{14.1}$$
其中$n\geq 1,f(0)=1$。  
第八章的习题16用生成函数求解了这个递归式，其解是卡特兰数。

**Corollary 14.3.** 长度为$n$的排列中没有132模式的个数是卡特兰数$c_n=\begin{pmatrix}2n\\n\end{pmatrix}/(n+1)$。

我们知道了`132-avoiding`的数量。那其他模式呢？在讨论前，先给出一般模式的定义。  
**Definition 14.4.** 令$p$是$n$排列，$q=q_1q_2\cdots q_k$是$k$排列，其中$n\geq k$。从$p$中选择$k$项，保持它们的相对顺序不变，各项分别是$a_1,a_2,\cdots,c_k$。如果对于下标$i,j$其中$q_i<q_j$，有$a_i<a_j$，那么我们称$a_1,a_2,\cdots,c_k$形成了$q$模式。  
**Definition 14.5.** 令$p$是$n$排列，$q=q_1q_2\cdots q_k$是$k$排列，其中$n\geq k$。如果$p$中没有$k$个元素形成$q$模式，那么称$p$是$q$`-avoiding`排列。

$q$`-avoiding`的$n$排列数量记作$S_n(q)$，或$A_{v_n}(q)$。  
我们继续回到长度为3的问题上。  
231和132刚好相反，如果一个排列没有132，那么反过来的排列没有231模式，反之亦然。那么在这两者之间建立了双射。所以$S_n(231)=S_n(132)$。  
定义$n$排列$p=p_1p_2\cdots p_n$的补集(`complement`)是$\bar{p}$，它的第一项是$n+1-p_1$，第二项是$n+1-p_2$，第$i$项是$n+1-p_i$。比如$34152$是$32514$的补集。  
132的补集是312，如果$p$没有312模式，那么$p_c$没有132模式，反之亦然。那么$S_n(312)=S_n(132)$。  
同理213和312恰好相反。综上$S_n(132)=S_n(231)=S_n(312)=S_n(213)$。  
还剩余两个模式没有讨论：123和321。它们互补，同时刚好相反，所以$S_n(123)=S_n(321)$。那么$S_n(123)=S_n(132)$成立吗？如果成立，那么$n$排列的长度为3的`avoiding`排列数都是相同的。答案是肯定的，不过证明没有上面这些那么明显。

**Lemma 14.6.** 对于所有正整数$n$，$S_n(123)=S_n(132)$成立。  
证明之前，我们先回顾一个概念。排列中的某项如果是从左往右最小的项，那么称为左到右最小值(`left-to-right minimum`)。一个排列所有的左到右最小值是降序。比如排列4531762，左到右最小值是4、3、1。1总是左到右最小值。  
**Proof.** 保持左到右最小值位置不变，可以容易构造一个从123`avoiding`排列到132`avoiding`排列的双射。  
取任意一个123`avoiding`排列$p$，固定所有的左到右最小值，移除其他项保留空位置。然后从左往右，把移除的值填回空位置，要求是选择大于左边的左到右最小值的且是剩余数中最小的一个。这样保持原有的左到右最小值还是最小值。举个例子，$p=465132$，保留4和1，然后4后面的空选择5和6中的小的那个，即5，然后一个空只能填入6。后面两个空置同理。得到$f(p)=456123$。  
$f(p)$是132`avoiding`排列。每一段从左到右最小值开始到下一个最小值之前，都是升序，每一段是降序，找不到132模式。  
$f$的逆也比较容易构造。保持左到右最小值不变，两个最小值之前的元素按照降序重排。就是一个123`avoiding`排列。

**Theorem 14.7.** 令$p$是任意一个长度为3的排列模式。那么对于所有正整数$n$都有
$$S_n(q)=c_n=\frac{\begin{pmatrix}
2n\\n
\end{pmatrix}}{n+1}$$
**Proof.** 前面证明了各个长度为3的排列模式都是132等价，且$S_n(132)=c_n$。

讨论完了长度为3的各种模式。更长的模式$q$呢？事实上只有很少的$q$有明确的公式$S_n(q)$。以长度为4为例，有24种模式，使用反转、补集和一些小技巧，可以去掉一些重复的模式，最后有三种不同的模式：1234，1342，1324。使用计算机得到前几项如下：
$$S_n(1342):1,2,6,23,103,512,2740,15485$$
$$S_n(1234):1,2,6,23,103,513,2761,17676$$
$$S_n(1324):1,2,6,23,103,513,2762,15793$$
与长度为3的模式不同，$S_n(q)$不依赖于$q$不成立了。对于$n\geq 7$，
$$S_n(1342)<S_n(1234)<S_n(1324)$$
上面的不等式是成立的。其中不容易理解的是顺序模式1234居中。似乎这种特殊的应该是最容易避免或者是最不容易的，也就是在不等式两头更符合直觉。  
下面证明不等式的第二部分。第一部分的证明在习题7给出的论文里面证明的。  
**Theorem 14.8.** 对于所有$n\geq 7$，不等式$S_n(1234)<S_n(1324)$成立。  
**Proof.** 我们对于所有$n$排列按照左到右最小值和右到左最大值的值和位置进行分类。  
**Definition 14.9.** 两个排列$x,y$满足以下条件的话是同一类的：
* 左到右最小值相同
* 且位置相同
* 右到左最大值也成立

比如$x=51234,y=51324$是同一类，而$z=24315,v=24135$就不在一类，因为$v$的第三位是左到右最小值而$z$的第三位不是。  
我们证明的思路是每一个非空类里包含且只包含一个1234`avoiding`排列并且至少包含一个1324`avoiding`排列，然后证明有一些类中包含不止一个1324`avoiding`排列。  
**Lemma 14.10.** 每一个非空类包含且只包含一个1234`avoiding`排列。  
**Proof.** 选择一个类，固定所有左到右最小值和右到左最大值，然后将剩余的元素降序放入其余位置，得到一个1234`avoiding`排列。  
因为这样组成的排列包含三个降序序列，分别是最后放入的剩余元素、左到右最小值序列和右到左最大值序列。如果这是一个包含1234模式的排列，根据鸽巢原理，至少有一个序列包含两个元素，而这两个要是升序，矛盾。另一方面，如果有两个元素$a,b$是升序，那么它们和$a$左边的左到右最小值、$b$右边的右到左最大值组成一个1234模式。也就是说，除了降序放其余序列之外，没有其他的排列是1234`avoiding`排列了。

回一下倒置(`inversion`)的概念，对于一个排列$p=p_1p_2\cdots p_n$的一个对$(p_i,p_j), i<j$，但是$p_i>p_j$，这对数就是倒置。  
**Lemma 14.11.** 每一个非空类包含至少一个1324`avoiding`排列。  
**Proof.** 如果一个排列存在1324模式，那么如果最左边的数不是左到右最小值，那么可以用左到右最小值替换，同理最右边可以用右到左最大值替换。那么如果一个排列是1324`avoiding`的，那么不能有一个1324模式，其第一个元素是左到右最小值，最后一个元素是右到左最大值。（下面称包含这样的模式称为好模式(`good pattern`)。）需要注意的是左到右最小值只能是第一个元素，右到左最大值也只能是最后一个元素。  
任取一个包含1324模式的排列。一定有好模式（没有可以通过替换得到），然后交换32对应的元素，不破坏约束条件。没有比某个左到右最小值$y$还小的$x$换到$y$的左侧，右到左最大值同理。每一步都会减少一个倒置，最多$\begin{pmatrix}n\\2\end{pmatrix}$之后会停止，这一系列排列都同属一个类。最后停止的排列明显没有好模式了，是1324`avoiding`排列。  
**Notation (by example)** 
